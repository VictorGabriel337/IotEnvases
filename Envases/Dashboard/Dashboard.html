<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="Dashboard.css" rel="stylesheet" />
    <title>Dashboard</title>
</head>
<body>
    <video autoplay muted loop id="videoBG">
        <source src="video/videoplayback.mp4" type="video/mp4">
    </video> 

    <iframe class="sidebar-iframe" scrolling="no" src="../sidebar/Sidebar.html"></iframe>

    <div class="main">
        <div class="primeira-coluna">
            <div class="definir">
                <h3 class="text1">Produto</h3>
                <div class="icon-img"> <img src="img/silhueta-garrafa.png"></div>
                <select id="produtoSelect">
                    <option value="card-coca/coca.html">Coca-cola original</option>
                    <option value="card-coca/zero.html">Coca-cola zero</option>
                    <option value="card-coca/fanta.html">Bi Fanta</option>
                    <option value="garrafa sem rotulo">Garrafa sem rotulo</option>
                </select>
            </div>
            <div class="definir">
                <h3 class="text1">Garrafa produzida</h3>
                <div class="icon-img"> <img src="img/silhueta-garrafa.png"></div>
                <p id="lowCount" class="sensorlow">Carregando...</p>  
            </div>
            <div class="definir">
                <h3 class="text1">Maq. Parada</h3>
                <div class="icon-img"> <img src="img/silhueta-garrafa.png"></div>
                <p id="maqParada" class="sensorlow">Carregando...</p>
            </div>
            <div class="definir">
                <h3 class="text1">Maq. Produzindo</h3>
                <div class="icon-img"> <img src="img/silhueta-garrafa.png"></div>
                <p id="maqProduzindo" class="sensorlow">Carregando...</p>
            </div>
        </div>

        <div class="segunda-coluna">
            <div class="prim-coluna">
                <iframe id="produtoIframe" class="coca-iframe" scrolling="no" src="card-coca/coca.html"></iframe>
            </div>
        </div>
    </div> <!--div main-->

    <!-- Biblioteca Paho MQTT -->
    <script src="https://cdn.jsdelivr.net/npm/paho-mqtt@1.1.0/mqttws31.min.js" defer></script>

    <script>
        // Função que usa a biblioteca Paho MQTT
        const host = "534dc0a4d7544a60a30022826acda692.s1.eu.hivemq.cloud:8884/mqtt";
        const port = 8884; // Porta WSS segura
        const username = "Iotenvases";
        const password = "Iotenvases42";
        const topic = "machine/status";

        const clientId = "client-" + Math.random().toString(16).substr(2, 8);

        const client = new Paho.MQTT.Client(host, port, "/mqtt", clientId);

        client.onConnectionLost = function (responseObject) {
            console.log("Conexão perdida:", responseObject.errorMessage);
        };

        client.onMessageArrived = function (message) {
            console.log("Mensagem recebida:", message.payloadString);
            const dados = JSON.parse(message.payloadString);

            // Atualiza os elementos na página
            document.getElementById("lowCount").innerText = dados.lowSignalCount ?? "--";
            document.getElementById("maqParada").innerText = dados.nonCadenceTotalTime ?? "--";
            document.getElementById("maqProduzindo").innerText = dados.cadenceTotalTime ?? "--";
        };

        client.connect({
            useSSL: true,
            userName: username,
            password: password,
            onSuccess: function () {
                console.log("Conectado ao broker MQTT com sucesso!");
                client.subscribe(topic);
            },
            onFailure: function (err) {
                console.error("Erro ao conectar:", err);
            }
        });
    </script>
</body>
</html>
